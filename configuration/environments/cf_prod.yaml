---
target:
  metadata:
    product_portfolio_name: &productName 'connected-facilities'
    environment_name: &environmentName 'Prod'
    default_azure_location: &defaultAzureLocation 'eastus'
    default_azure_subscription: &defaultAzureSubscription 'e331d580-f48b-45d5-85c0-166dc80f3ed3'  # Acuity Brands, Inc. ConnectedFacilities-Prod
    tls_cert_subscription: &subscription_tls '5e49f516-d005-4ae8-a287-031c8573401c'  # Acuity Brands, Inc. Allspice-Dev
    dns_subscription: &subscription_dns '5e49f516-d005-4ae8-a287-031c8573401c'  # Acuity Brands, Inc. Allspice-Dev
    service_deployment:
      tenant: &acuityDefaultTenant 'caadbe96-024e-4f67-82ec-fb28ff53d16d'  # Acuity Brands, Inc.
      atrius_api_host: &atriusApiHost 'api.us.atrius-iot.io'
      authn_tenant: &environmentTenant 'common'  # allow all AD tenants to authenticate
      passage_api_host: &passageApiHost 'passage.atrius-us.acuitynext.io'
    app_registration:
      tenant: &appRegistrationTenant 'db566806-bf04-4296-98cc-ba6d2d950788'  # Acuity Brands Technical Services, INC
      application_id: &appRegistrationID '6d566d2d-acfa-4fb0-a56b-c48ccc07cc53'  # Acuity Brands Atrius US UI
      passage_api_application_id: &passageApiApplicationID 'd9253624-7e87-426c-8132-75858e1dcf0b'  # Acuity Brands Atrius US Passage API
      # application_id: &appRegistrationID 'ca8318ee-a3f8-45d4-b284-0ec0ce809789'  # @@ TODO - manual setup due to insufficient permissions in AZ CLI
    objectsDatabases:
      - db_name: &cfObjectsDBName_001 'pltdata01sqls5vysxyq75v'
        reader_name: &cfObjectsDBUser_001 'CF_Reader'
        secret_name: &cfObjectsDBSecretName_001 'ATRDEMO01US-CFReader-SQLUserPassword'
      - db_name: &cfObjectsDBName_002 'pltdata01sqlsbb6ahiz252'
        reader_name: &cfObjectsDBUser_002 'CF_Reader'
        secret_name: &cfObjectsDBSecretName_002 'ATRPROD02US-CFReader-SQLUserPassword'
    key_names:
      self_healing_api_key: &cfDefaultSelfHealingApiKeyName 'cf-self-healing-api-key'
      cf_elm_web_api_sp_client_secret: &cfElmWebApiSPClientSecret 'cf-elm-web-api-sp-client-secret'
      cf_lights_map_api_key: &cfLightsMapApiKey 'cf-prod-lights-map-api-key'
  iaas:
    location: *defaultAzureLocation
    resource_groups:
      # for naming conventions, see: https://docs.acuitynext.net/wiki/azure-naming-conventions/
      # pre-existing Atrius resource groups with shared configuration state
      - name: &atriusDnsRG 'atriusops-allspicedev'
        action: 'read'
      # CF Prod resource groups
      - name: &cfWafRG 'Waf-prod-CfProd'
        action: 'create'
      - name: &cfDbRG 'Data-prod-CfProd'
        action: 'create'
      - name: &cfKeysRG 'Kv-prod-CfProd'
        action: 'create'
      - name: &cfAcrRG 'Acr-prod-CfProd'
        action: 'create'
      - name: &cfNetworksRG 'Vnet-prod-CfProd'
        action: 'create'
      - name: &cfAppSvcRG 'Web-prod-CfProd'
        action: 'create'
      - name: &cfAuthNSvcRG 'Authn-prod-CfProd'
        action: 'create'
      - name: &cfIngestSvcRG 'Ingestion-prod-CfProd'
        action: 'create'
    networking:
      public_ip:
        - name: &wafIP 'cf-prod-waf-pip'
          resource_group: *cfWafRG
          subscription: *defaultAzureSubscription
          arm_type: 'Microsoft.Network/publicIPAddresses'
          sku: 'Standard'
          allocation_method: 'Static'
          action: 'create'
        - name: &postAuthnIP 'cf-prod-post-auth-pip'
          resource_group: *cfAuthNSvcRG
          subscription: *defaultAzureSubscription
          arm_type: 'Microsoft.Network/publicIPAddresses'
          sku: 'Standard'
          allocation_method: 'Static'
          action: 'create'
        - name: &ingestVMIP 'cf-prod-ingest-vm-pip'
          resource_group: *cfIngestSvcRG
          subscription: *defaultAzureSubscription
          arm_type: 'Microsoft.Network/publicIPAddresses'
          sku: 'Standard'
          allocation_method: 'Static'
          action: 'create'
      dns_a_records:
        - zone: &dnsZone 'dev.atrius-iot.com'
          host: &dnsHost 'cf-prod'
          fqdn: &wafFqdn 'cf-prod.dev.atrius-iot.com.'
          resource_group: *atriusDnsRG
          subscription: *subscription_dns
          a_record_ttl: 3600
          a_record_public_ip: *wafIP
          action: 'create'
        - zone: 'dev.atrius-iot.com'
          host: &postAuthnGateway 'cf-prod-post-authn-ag'
          fqdn: &postAuthnGatewayFqdn 'cf-prod-post-authn-ag.dev.atrius-iot.com.'
          resource_group: *atriusDnsRG
          subscription: *subscription_dns
          a_record_ttl: 3600
          a_record_public_ip: *postAuthnIP
          action: 'create'
      vnets:
        - name: 'cf-prod-vnet'
          resource_group: *cfNetworksRG
          cidr: '10.1.0.0/16'
          arm_type: 'Microsoft.Network/virtualNetworks'
          action: 'create'
          subnets:
            - name: 'cf-prod-0-subnet'
              cidr: '10.1.0.0/24'
            - name: 'cf-prod-1-subnet'
              cidr: '10.1.1.0/24'
        - name: &ingestVnet 'cf-prod-ingest-vnet'
          resource_group: *cfNetworksRG
          cidr: '10.2.0.0/16'
          arm_type: 'Microsoft.Network/virtualNetworks'
          action: 'create'
          subnets:
            - name: &ingestSubnet 'cf-prod-0-subnet'
              cidr: '10.2.0.0/24'
            - name: 'cf-prod-1-subnet'
              cidr: '10.2.1.0/24'
  paas:
    location: *defaultAzureLocation
    keyvaults:
      # pre-existing Atrius key vault with shared configuration state such as TLS certificate
      - name: &atriusKVName 'atrius01kvbxkbdsepg6'
        action: 'read'
      # CF Prod Key Vault
      - name: &kvName 'cf-prod-master-kv'
        resource_group: *cfKeysRG
        arm_type: 'Microsoft.KeyVault/vaults'
        action: 'create'
    databases:
      servers:
        - name: &cfDefaultDbServer 'cf-prod-sqls'
          arm_type: 'Microsoft.Sql/servers'
          subscription: *defaultAzureSubscription
          resource_group: *cfDbRG
          admin_name: &cfDefaultDBAdminName 'cf-prod-sqls-admin-user'
          admin_password_kv:
            vault: *kvName
            resource_group: *cfKeysRG
            secret_name: &cfDefaultDBSecretName 'admin-pw-for-cf-prod-sqls'
          default_firewall_rule:
            name: 'AllowAllWindowsAzureIps'
            arm_type: 'Microsoft.Sql/servers/firewallRules'
            start_ip_address: '0.0.0.0'
            end_ip_address: '0.0.0.0'
          action: 'preserve'
      instances:
        - name: &selfHealingSchema 'cf-prod-self-healing'
          arm_type: 'Microsoft.Sql/servers/databases'
          resource_group: *cfDbRG
          server: *cfDefaultDbServer
          license_type: 'LicenseIncluded'
          max_size: '250GB'
          zone_redundant: false
          catalog_collation: 'SQL_Latin1_General_CP1_CI_AS'
          collation: 'SQL_Latin1_General_CP1_CI_AS'
          capacity: 14
          tier: 'GeneralPurpose'
          family: 'Gen5'
          service_objective: 'GP_S_Gen5'
          action: 'preserve'
        - name: &authzSchema 'cf-prod-authz-db'
          arm_type: 'Microsoft.Sql/servers/databases'
          resource_group: *cfDbRG
          server: *cfDefaultDbServer
          license_type: 'LicenseIncluded'
          max_size: '250GB'
          zone_redundant: false
          catalog_collation: 'SQL_Latin1_General_CP1_CI_AS'
          collation: 'SQL_Latin1_General_CP1_CI_AS'
          capacity: 14
          tier: 'GeneralPurpose'
          family: 'Gen5'
          service_objective: 'GP_S_Gen5'
          action: 'preserve'
        - name: &netWorkViewSchema 'cf-prod-network-view-db'
          arm_type: 'Microsoft.Sql/servers/databases'
          resource_group: *cfDbRG
          server: *cfDefaultDbServer
          license_type: 'LicenseIncluded'
          max_size: '250GB'
          zone_redundant: false
          catalog_collation: 'SQL_Latin1_General_CP1_CI_AS'
          collation: 'SQL_Latin1_General_CP1_CI_AS'
          capacity: 14
          tier: 'GeneralPurpose'
          family: 'Gen5'
          service_objective: 'GP_S_Gen5'
          action: 'preserve'
        - name: &elmSchema 'cf-prod-elm-db'
          arm_type: 'Microsoft.Sql/servers/databases'
          resource_group: *cfDbRG
          server: *cfDefaultDbServer
          license_type: 'LicenseIncluded'
          max_size: '250GB'
          zone_redundant: false
          catalog_collation: 'SQL_Latin1_General_CP1_CI_AS'
          collation: 'SQL_Latin1_General_CP1_CI_AS'
          capacity: 14
          tier: 'GeneralPurpose'
          family: 'Gen5'
          service_objective: 'GP_S_Gen5'
          action: 'preserve'
        - name: &adminSchema 'cf-prod-admin-db'
          arm_type: 'Microsoft.Sql/servers/databases'
          resource_group: *cfDbRG
          server: *cfDefaultDbServer
          license_type: 'LicenseIncluded'
          max_size: '250GB'
          zone_redundant: false
          catalog_collation: 'SQL_Latin1_General_CP1_CI_AS'
          collation: 'SQL_Latin1_General_CP1_CI_AS'
          capacity: 14
          tier: 'GeneralPurpose'
          family: 'Gen5'
          service_objective: 'GP_S_Gen5'
          action: 'preserve'
    server_farms:
      - name: &authServiceFarm 'cf-prod-authservice-asp'
        arm_type: 'Microsoft.Web/serverFarms'
        resource_group: *cfAuthNSvcRG
        is_linux: true
        number_of_workers: 1
        sku: 'P1V2'
        action: 'create'
      - name: &webServiceFarm 'cf-prod-webservice-asp'
        arm_type: 'Microsoft.Web/serverFarms'
        resource_group: *cfAppSvcRG
        is_linux: true
        number_of_workers: 1
        sku: 'P1V2'
        action: 'create'
    container_registries:
      - name: &primaryACR 'cfprodregistry'
        arm_type: 'Microsoft.ContainerRegistry/registries'
        resource_group: *cfAcrRG
        uri: &uriPrimaryACR 'https://cfprodregistry.azurecr.io'
        sku: 'Premium'
        admin_enabled: true
        action: 'create'
    virtual_machines:
      - name: &cfIngestServer 'prod-ingest-vm'  # must be <= 15 chars
        arm_type: 'Microsoft.Compute/virtualMachines'
        subscription: *defaultAzureSubscription
        resource_group: *cfIngestSvcRG
        admin_name: &cfDefaultIngestVmAdminName 'prod-ingest-admin'  # must be <= 20 chars
        admin_password_kv:
          vault: *kvName
          resource_group: *cfKeysRG
          secret_name: &cfDefaultIngestVmSecretName 'admin-pw-for-cf-prod-ingest-vm'
        license_type: 'Windows_Server'
        public_ip_address: *ingestVMIP
        disks:
          os_disk:
            os_disk_name: 'cfprod-ingest-os-disk'
            os_disk_caching: 'ReadWrite'
            os_disk_size_gb: 127
          data_disks:  # these do not auto-format or auto-mount [yet]
            data_disk_caching: 'ReadWrite'
            data_disk_sizes_gb:
              - 1000
        # boot_diagnostics_storage: "$(server_attr 'boot_diagnostics_storage')"
        location: *defaultAzureLocation
        image: 'MicrosoftWindowsServer:WindowsServer:2016-Datacenter:latest'
        size: 'Standard_DS2_v2'
        priority: 'Regular'
        authentication_type: 'password'
        vnet_name: *ingestVnet
        subnet_name: *ingestSubnet
        action: 'preserve'
  saas:
    authn_services:
      farm: *authServiceFarm
      services:
        - name: &cfAuthnService 'cf-prod-auth-proxy'
          arm_type: 'Microsoft.Web/sites'
          resource_group: *cfAuthNSvcRG
          container:
            registry: *primaryACR
            name: &authnContainer 'cf-oauth-proxy-docker'
            tag: &authnTag 'connected-facilities'
          acr_webhook:
            name: 'cfprodauthproxywh'
            registry: *primaryACR
            resource_group: *cfAcrRG
            status: 'enabled'
            actions:
              - 'push'
            arm_type: 'Microsoft.ContainerRegistry/registries/webhooks'
          config:
            DOCKER_ENABLE_CI: true
            DOCKER_REGISTRY_SERVER_PASSWORD:
              - '##acr_registry_key={"registry":"'
              - *primaryACR
              - '","resource_group":"'
              - *cfAcrRG
              - '"}'
              - '##'
            DOCKER_REGISTRY_SERVER_URL: *uriPrimaryACR
            DOCKER_REGISTRY_SERVER_USERNAME: *primaryACR
            OAUTH2_PROXY_AZURE_TENANT: *environmentTenant
            OAUTH2_PROXY_CLIENT_ID: *passageApiApplicationID
            OAUTH2_PROXY_CLIENT_SECRET:
              - '##secure_secret={"vault":"'
              - *kvName
              - '","secret_name":"'
              - &oauthProxyClientSecretName 'cf-prod-oauth2-proxy-client-secret'
              - '"}'
              - '##'
            OAUTH2_PROXY_COOKIE_EXPIRE: '4320h'
            OAUTH2_PROXY_COOKIE_NAME:
              - 'ConnectedFacilities_AUTHN'
              - '_'
              - *dnsHost
              - '_'
              - *environmentName
              - '__utm'
            OAUTH2_PROXY_COOKIE_PATH: '/'
            OAUTH2_PROXY_COOKIE_REFRESH: '1h'
            OAUTH2_PROXY_COOKIE_SECRET:
              - '##secure_secret={"vault":"'
              - *kvName
              - '","secret_name":"'
              - 'cf-prod-oauth2-proxy-cookie-secret'
              - '"}'
              - '##'
            OAUTH2_PROXY_EMAIL_DOMAINS: '*'
            OAUTH2_PROXY_EXTRA_JWT_ISSUERS: &trustedIdProviders
              - 'https://sts.windows.net/caadbe96-024e-4f67-82ec-fb28ff53d16d/'
              - '='
              - 'https://management.core.windows.net/'
              - ','
              - 'https://sts.windows.net/db566806-bf04-4296-98cc-ba6d2d950788/'
              - '='
              - 'https://management.core.windows.net/'
              - ','
              - 'https://sts.windows.net/f687c0f3-9126-45bd-b994-b96df8a19c91/'
              - '='
              - 'https://management.core.windows.net/'
              - ','
              - 'https://sts.windows.net/caadbe96-024e-4f67-82ec-fb28ff53d16d/'
              - '='
              - 'https://graph.windows.net'
              - ','
              - 'https://sts.windows.net/db566806-bf04-4296-98cc-ba6d2d950788/'
              - '='
              - 'https://graph.windows.net'
              - ','
              - 'https://sts.windows.net/f687c0f3-9126-45bd-b994-b96df8a19c91/'
              - '='
              - 'https://graph.windows.net'
              - ','
              - 'https://sts.windows.net/caadbe96-024e-4f67-82ec-fb28ff53d16d/'
              - '='
              - *passageApiApplicationID
            OAUTH2_PROXY_HTTP_ADDRESS: '0.0.0.0:4180'
            OAUTH2_PROXY_PASS_ACCESS_TOKEN: true
            OAUTH2_PROXY_PASS_AUTHORIZATION_HEADER: true
            OAUTH2_PROXY_PING_PATH: '/'
            OAUTH2_PROXY_PROVIDER: 'azure'
            OAUTH2_PROXY_REDIRECT_URL: &appAuthCallbackURL
              - 'https://'
              - *dnsHost
              - '.'
              - *dnsZone
              - '/oauth2/callback'
            OAUTH2_PROXY_RESOURCE: *passageApiApplicationID
            OAUTH2_PROXY_SET_AUTHORIZATION_HEADER: true
            OAUTH2_PROXY_SILENCE_PING_LOGGING: true
            OAUTH2_PROXY_SKIP_AUTH_REGEX:  # @@ TODO TECHDEBT API without a JWT token / ServicePrincipal
              - '^/cf-self-healing-api/api/v1/process'
              - ','
              - '^/cf-lights-map/distech-eclypse'
            OAUTH2_PROXY_SKIP_JWT_BEARER_TOKENS: true
            OAUTH2_PROXY_SKIP_PROVIDER_BUTTON: true
            OAUTH2_PROXY_UPSTREAMS:  # @@ TODO private ip on vnet
              - 'https://'
              - *postAuthnGatewayFqdn
            WEBSITES_ENABLE_APP_SERVICE_STORAGE: false
            WEBSITES_PORT: 4180
            WEBSITE_HTTPLOGGING_RETENTION_DAYS: 7
          connection_strings:
          container_settings:
            DOCKER_CUSTOM_IMAGE_NAME:
              - 'DOCKER|'
              - *primaryACR
              - '.azurecr.io/'
              - *authnContainer
              - ':'
              - *authnTag
            DOCKER_REGISTRY_SERVER_PASSWORD:
              - '##acr_registry_key={"registry":"'
              - *primaryACR
              - '","resource_group":"'
              - *cfAcrRG
              - '"}'
              - '##'
            DOCKER_REGISTRY_SERVER_URL: *uriPrimaryACR
            DOCKER_REGISTRY_SERVER_USERNAME: *primaryACR
            WEBSITES_ENABLE_APP_SERVICE_STORAGE: false
          logging: &defaultWebAppLogging
            application_logging: true
            detailed_error_messages: true
            docker_container_logging: 'filesystem'
            failed_request_tracing: true
            level: 'warning'
            web_server_logging: 'filesystem'
          tls: 'true'
          access_restrictions:
            - priority: 1
              rule_name: 'downstream WAF'
              action: 'Allow'
              description: 'only allow access from downstream WAF'
              ignore_missing_endpoint: 'true'
              scm_site: 'false'
              subnet:
                - '/subscriptions/'
                - *defaultAzureSubscription
                - '/resourceGroups/'
                - *cfWafRG
                - '/providers/Microsoft.Network/virtualNetworks/'
                - &wafAgName 'cf-prod-waf-ag'
                - 'Vnet'
                - '/subnets/default'
          action: 'create'
    web_services:
      farm: *webServiceFarm
      services:
        # Health services
        - name: &cfHealthApp 'cf-prod-app'
          arm_type: 'Microsoft.Web/sites'
          resource_group: *cfAppSvcRG
          container:
            registry: *primaryACR
            name: &healthAppContainer 'cf-react-app-docker'
            tag: &healthAppTag 'connected-facilities'
          acr_webhook:
            name: 'cfprodappwh'
            registry: *primaryACR
            resource_group: *cfAcrRG
            status: 'enabled'
            actions:
              - 'push'
            arm_type: 'Microsoft.ContainerRegistry/registries/webhooks'
          config:
            DOCKER_ENABLE_CI: true
            DOCKER_REGISTRY_SERVER_PASSWORD:
              - '##acr_registry_key={"registry":"'
              - *primaryACR
              - '","resource_group":"'
              - *cfAcrRG
              - '"}'
              - '##'
            DOCKER_REGISTRY_SERVER_URL: *uriPrimaryACR
            DOCKER_REGISTRY_SERVER_USERNAME: *primaryACR
            WEBSITES_ENABLE_APP_SERVICE_STORAGE: false
            WEBSITE_HTTPLOGGING_RETENTION_DAYS: 7
          connection_strings:
          container_settings:
            DOCKER_CUSTOM_IMAGE_NAME:
              - 'DOCKER|'
              - *primaryACR
              - '.azurecr.io/'
              - *healthAppContainer
              - ':'
              - *healthAppTag
            DOCKER_REGISTRY_SERVER_PASSWORD:
              - '##acr_registry_key={"registry":"'
              - *primaryACR
              - '","resource_group":"'
              - *cfAcrRG
              - '"}'
              - '##'
            DOCKER_REGISTRY_SERVER_USERNAME: *primaryACR
            DOCKER_REGISTRY_SERVER_URL: *uriPrimaryACR
            WEBSITES_ENABLE_APP_SERVICE_STORAGE: false
          logging: *defaultWebAppLogging
          tls: 'true'
          access_restrictions:
            - priority: 1
              rule_name: 'downstream AuthN'
              action: 'Allow'
              description: 'only allow access from downstream AuthN'
              ignore_missing_endpoint: 'true'
              scm_site: 'false'
              subnet:
                - '/subscriptions/'
                - *defaultAzureSubscription
                - '/resourceGroups/'
                - *cfAuthNSvcRG
                - '/providers/Microsoft.Network/virtualNetworks/'
                - *postAuthnGateway
                - 'Vnet'
                - '/subnets/default'
          action: 'create'
        # AuthZ Web Api service
        - name: &authzWebApi 'cf-prod-authz-web-api'
          arm_type: 'Microsoft.Web/sites'
          resource_group: *cfAppSvcRG
          path: &authzPath '/cf-authz'
          http_url: &authzApiUrl
            - 'https://'
            - *wafFqdn
            - *authzPath
          container:
            registry: *primaryACR
            name: &authzWebApiContainer 'cf-authz-web-api-docker'
            tag: &authzWebApiTag 'connected-facilities'
          acr_webhook:
            name: 'cfprodauthzwebapiwh'
            registry: *primaryACR
            resource_group: *cfAcrRG
            status: 'enabled'
            actions:
              - 'push'
            arm_type: 'Microsoft.ContainerRegistry/registries/webhooks'
          config:
            AZURE_DB: 'true'
            DOCKER_ENABLE_CI: true
            DOCKER_REGISTRY_SERVER_PASSWORD:
              - '##acr_registry_key={"registry":"'
              - *primaryACR
              - '","resource_group":"'
              - *cfAcrRG
              - '"}'
              - '##'
            DOCKER_REGISTRY_SERVER_URL: *uriPrimaryACR
            DOCKER_REGISTRY_SERVER_USERNAME: *primaryACR
            JWT_ISSUERS: *trustedIdProviders
            RAILS_LOG_TO_STDOUT: 'true'
            WEBSITES_ENABLE_APP_SERVICE_STORAGE: false
            WEBSITE_HTTPLOGGING_RETENTION_DAYS: 7
          connection_strings:
            SQLServer:
              DATABASE_URL:
                - 'sqlserver://'
                - *cfDefaultDBAdminName
                - ':'
                - '##secure_secret={"vault":"'
                - *kvName
                - '","secret_name":"'
                - *cfDefaultDBSecretName
                - '"}'
                - '##'
                - '@'
                - *cfDefaultDbServer
                - '.database.windows.net:'
                - 1433
                - '/'
                - *authzSchema
          container_settings:
            DOCKER_CUSTOM_IMAGE_NAME:
              - 'DOCKER|'
              - *primaryACR
              - '.azurecr.io/'
              - *authzWebApiContainer
              - ':'
              - *authzWebApiTag
            DOCKER_REGISTRY_SERVER_PASSWORD:
              - '##acr_registry_key={"registry":"'
              - *primaryACR
              - '","resource_group":"'
              - *cfAcrRG
              - '"}'
              - '##'
            DOCKER_REGISTRY_SERVER_USERNAME: *primaryACR
            DOCKER_REGISTRY_SERVER_URL: *uriPrimaryACR
            WEBSITES_ENABLE_APP_SERVICE_STORAGE: false
          logging: *defaultWebAppLogging
          tls: 'true'
          access_restrictions:
            - priority: 1
              rule_name: 'downstream AuthN'
              action: 'Allow'
              description: 'only allow access from downstream AuthN'
              ignore_missing_endpoint: 'true'
              scm_site: 'false'
              subnet:
                - '/subscriptions/'
                - *defaultAzureSubscription
                - '/resourceGroups/'
                - *cfAuthNSvcRG
                - '/providers/Microsoft.Network/virtualNetworks/'
                - *postAuthnGateway
                - 'Vnet'
                - '/subnets/default'
          action: 'create'
        # Health Web Api Service
        - name: &healthWebApi 'cf-prod-health-web-api'
          arm_type: 'Microsoft.Web/sites'
          resource_group: *cfAppSvcRG
          container:
            registry: *primaryACR
            name: &healthWebApiContainer 'cf-network-view-web-api-docker'
            tag: &healthWebApiTag 'connected-facilities'
          acr_webhook:
            name: 'cfprodhealthwebapiwh'
            registry: *primaryACR
            resource_group: *cfAcrRG
            status: 'enabled'
            actions:
              - 'push'
            arm_type: 'Microsoft.ContainerRegistry/registries/webhooks'
          config:
            AZURE_DB: 'true'
            CF_AUTHZ_API_URL: *authzApiUrl
            DOCKER_ENABLE_CI: true
            DOCKER_REGISTRY_SERVER_PASSWORD:
              - '##acr_registry_key={"registry":"'
              - *primaryACR
              - '","resource_group":"'
              - *cfAcrRG
              - '"}'
              - '##'
            DOCKER_REGISTRY_SERVER_URL: *uriPrimaryACR
            DOCKER_REGISTRY_SERVER_USERNAME: *primaryACR
            RAILS_LOG_TO_STDOUT: 'true'
            WEBSITES_ENABLE_APP_SERVICE_STORAGE: false
            WEBSITE_HTTPLOGGING_RETENTION_DAYS: 7
          connection_strings:
            SQLServer:
              DATABASE_URL:
                - 'sqlserver://'
                - *cfDefaultDBAdminName
                - ':'
                - '##secure_secret={"vault":"'
                - *kvName
                - '","secret_name":"'
                - *cfDefaultDBSecretName
                - '"}'
                - '##'
                - '@'
                - *cfDefaultDbServer
                - '.database.windows.net:'
                - 1433
                - '/'
                - *netWorkViewSchema
          container_settings:
            DOCKER_CUSTOM_IMAGE_NAME:
              - 'DOCKER|'
              - *primaryACR
              - '.azurecr.io/'
              - *healthWebApiContainer
              - ':'
              - *healthWebApiTag
            DOCKER_REGISTRY_SERVER_PASSWORD:
              - '##acr_registry_key={"registry":"'
              - *primaryACR
              - '","resource_group":"'
              - *cfAcrRG
              - '"}'
              - '##'
            DOCKER_REGISTRY_SERVER_USERNAME: *primaryACR
            DOCKER_REGISTRY_SERVER_URL: *uriPrimaryACR
            WEBSITES_ENABLE_APP_SERVICE_STORAGE: false
          logging: *defaultWebAppLogging
          tls: 'true'
          access_restrictions:
            - priority: 1
              rule_name: 'downstream AuthN'
              action: 'Allow'
              description: 'only allow access from downstream AuthN'
              ignore_missing_endpoint: 'true'
              scm_site: 'false'
              subnet:
                - '/subscriptions/'
                - *defaultAzureSubscription
                - '/resourceGroups/'
                - *cfAuthNSvcRG
                - '/providers/Microsoft.Network/virtualNetworks/'
                - *postAuthnGateway
                - 'Vnet'
                - '/subnets/default'
          action: 'create'
        # Health Ingest Web Api Service
        - name: &ingestWebApi 'cf-prod-ingest-web-api'
          arm_type: 'Microsoft.Web/sites'
          resource_group: *cfAppSvcRG
          container:
            registry: *primaryACR
            name: &ingestWebApiContainer 'cf-network-view-web-api-docker'
            tag: &ingestWebApiTag 'connected-facilities'
          acr_webhook:
            name: 'cfprodingestwebapiwh'
            registry: *primaryACR
            resource_group: *cfAcrRG
            status: 'enabled'
            actions:
              - 'push'
            arm_type: 'Microsoft.ContainerRegistry/registries/webhooks'
          config:
            AZURE_DB: 'true'
            CF_AUTHZ_API_URL: *authzApiUrl
            DOCKER_ENABLE_CI: true
            DOCKER_REGISTRY_SERVER_PASSWORD:
              - '##acr_registry_key={"registry":"'
              - *primaryACR
              - '","resource_group":"'
              - *cfAcrRG
              - '"}'
              - '##'
            DOCKER_REGISTRY_SERVER_URL: *uriPrimaryACR
            DOCKER_REGISTRY_SERVER_USERNAME: *primaryACR
            RAILS_LOG_TO_STDOUT: 'true'
            WEBSITES_ENABLE_APP_SERVICE_STORAGE: false
            WEBSITE_HTTPLOGGING_RETENTION_DAYS: 7
          connection_strings:
            SQLServer:
              DATABASE_URL:
                - 'sqlserver://'
                - *cfDefaultDBAdminName
                - ':'
                - '##secure_secret={"vault":"'
                - *kvName
                - '","secret_name":"'
                - *cfDefaultDBSecretName
                - '"}'
                - '##'
                - '@'
                - *cfDefaultDbServer
                - '.database.windows.net:'
                - 1433
                - '/'
                - *netWorkViewSchema
          container_settings:
            DOCKER_CUSTOM_IMAGE_NAME:
              - 'DOCKER|'
              - *primaryACR
              - '.azurecr.io/'
              - *ingestWebApiContainer
              - ':'
              - *ingestWebApiTag
            DOCKER_REGISTRY_SERVER_PASSWORD:
              - '##acr_registry_key={"registry":"'
              - *primaryACR
              - '","resource_group":"'
              - *cfAcrRG
              - '"}'
              - '##'
            DOCKER_REGISTRY_SERVER_USERNAME: *primaryACR
            DOCKER_REGISTRY_SERVER_URL: *uriPrimaryACR
            WEBSITES_ENABLE_APP_SERVICE_STORAGE: false
          logging: *defaultWebAppLogging
          tls: 'true'
          access_restrictions:
            - priority: 1
              rule_name: 'downstream AuthN'
              action: 'Allow'
              description: 'only allow access from downstream AuthN'
              ignore_missing_endpoint: 'true'
              scm_site: 'false'
              subnet:
                - '/subscriptions/'
                - *defaultAzureSubscription
                - '/resourceGroups/'
                - *cfAuthNSvcRG
                - '/providers/Microsoft.Network/virtualNetworks/'
                - *postAuthnGateway
                - 'Vnet'
                - '/subnets/default'
          action: 'create'
        # Admin Web Api Service
        - name: &adminWebApi 'cf-prod-admin-web-api'
          arm_type: 'Microsoft.Web/sites'
          resource_group: *cfAppSvcRG
          container:
            registry: *primaryACR
            name: &adminWebApiContainer 'cf-admin-web-api-docker'
            tag: &adminWebApiTag 'connected-facilities'
          acr_webhook:
            name: 'cfprodadminwebapiwh'
            registry: *primaryACR
            resource_group: *cfAcrRG
            status: 'enabled'
            actions:
              - 'push'
            arm_type: 'Microsoft.ContainerRegistry/registries/webhooks'
          config:
            AZURE_DB: 'true'
            CF_AUTHZ_API_URL: *authzApiUrl
            DOCKER_ENABLE_CI: true
            DOCKER_REGISTRY_SERVER_PASSWORD:
              - '##acr_registry_key={"registry":"'
              - *primaryACR
              - '","resource_group":"'
              - *cfAcrRG
              - '"}'
              - '##'
            DOCKER_REGISTRY_SERVER_URL: *uriPrimaryACR
            DOCKER_REGISTRY_SERVER_USERNAME: *primaryACR
            RAILS_LOG_TO_STDOUT: 'true'
            WEBSITES_ENABLE_APP_SERVICE_STORAGE: false
            WEBSITE_HTTPLOGGING_RETENTION_DAYS: 7
          connection_strings:
            SQLServer:
              DATABASE_URL:
                - 'sqlserver://'
                - *cfDefaultDBAdminName
                - ':'
                - '##secure_secret={"vault":"'
                - *kvName
                - '","secret_name":"'
                - *cfDefaultDBSecretName
                - '"}'
                - '##'
                - '@'
                - *cfDefaultDbServer
                - '.database.windows.net:'
                - 1433
                - '/'
                - *adminSchema
          container_settings:
            DOCKER_CUSTOM_IMAGE_NAME:
              - 'DOCKER|'
              - *primaryACR
              - '.azurecr.io/'
              - *adminWebApiContainer
              - ':'
              - *adminWebApiTag
            DOCKER_REGISTRY_SERVER_PASSWORD:
              - '##acr_registry_key={"registry":"'
              - *primaryACR
              - '","resource_group":"'
              - *cfAcrRG
              - '"}'
              - '##'
            DOCKER_REGISTRY_SERVER_USERNAME: *primaryACR
            DOCKER_REGISTRY_SERVER_URL: *uriPrimaryACR
            WEBSITES_ENABLE_APP_SERVICE_STORAGE: false
          logging: *defaultWebAppLogging
          tls: 'true'
          access_restrictions:
            - priority: 1
              rule_name: 'downstream AuthN'
              action: 'Allow'
              description: 'only allow access from downstream AuthN'
              ignore_missing_endpoint: 'true'
              scm_site: 'false'
              subnet:
                - '/subscriptions/'
                - *defaultAzureSubscription
                - '/resourceGroups/'
                - *cfAuthNSvcRG
                - '/providers/Microsoft.Network/virtualNetworks/'
                - *postAuthnGateway
                - 'Vnet'
                - '/subnets/default'
          action: 'create'
        # ELM Web Api Service
        - name: &elmWebApi 'cf-prod-elm-web-api'
          arm_type: 'Microsoft.Web/sites'
          resource_group: *cfAppSvcRG
          elm_vault_secret_name: &cfElmSecretName 'cf-elm-web-api-sp-client-secret'
          container:
            registry: *primaryACR
            name: &elmWebApiContainer 'cf-elm-web-api-docker'
            tag: &elmWebApiTag 'connected-facilities'
          acr_webhook:
            name: 'cfprodelmwebapiwh'
            registry: *primaryACR
            resource_group: *cfAcrRG
            status: 'enabled'
            actions:
              - 'push'
            arm_type: 'Microsoft.ContainerRegistry/registries/webhooks'
          config:
            ATRIUS_API_URL:
              - 'https://'
              - *atriusApiHost
              - '/api/v1'
            AZURE_DB: 'true'
            CF_AUTHZ_API_URL: *authzApiUrl
            CF_OBJECTS_API_URL:
              - 'https://'
              - *dnsHost
              - '.'
              - *dnsZone
              - '/cf-atrius-objects'
            DOCKER_ENABLE_CI: true
            DOCKER_REGISTRY_SERVER_PASSWORD:
              - '##acr_registry_key={"registry":"'
              - *primaryACR
              - '","resource_group":"'
              - *cfAcrRG
              - '"}'
              - '##'
            DOCKER_REGISTRY_SERVER_URL: *uriPrimaryACR
            DOCKER_REGISTRY_SERVER_USERNAME: *primaryACR
            PASSAGE_API_URL:
              - 'https://'
              - *passageApiHost
              - '/api/v1'
            PASSAGE_REFERER: 'https://cf.us.atrius-iot.com'
            PASSAGE_HOST:
              - *passageApiHost
            RAILS_LOG_TO_STDOUT: 'true'
            RELAY_API_URL:
              - 'https://'
              - *passageApiHost
              - '/api/v1/Devices'
            # SECRET_KEY_BASE: 'fd54dc7d647688aa71dc5bfeb5cac675728d5c8dc6762ebcf242f1eb7f65b85dbddef5e5330a11ec8401b319f7ae0bcff1bec920d041868777814dd86e9a7bd8'
            SERVICE_PRINCIPAL_CLIENT_ID: '453111ae-5c35-4369-9807-2aff96da2def'
            SERVICE_PRINCIPAL_TENANT_ID: *acuityDefaultTenant
            SERVICE_PRINCIPAL_RESOURCE: *passageApiApplicationID
            WEBSITES_ENABLE_APP_SERVICE_STORAGE: false
            WEBSITE_HTTPLOGGING_RETENTION_DAYS: 7
          connection_strings:
            SQLServer:
              DATABASE_URL:
                - 'sqlserver://'
                - *cfDefaultDBAdminName
                - ':'
                - '##secure_secret={"vault":"'
                - *kvName
                - '","secret_name":"'
                - *cfDefaultDBSecretName
                - '"}'
                - '##'
                - '@'
                - *cfDefaultDbServer
                - '.database.windows.net:'
                - 1433
                - '/'
                - *elmSchema
            Custom:
              # @@ TODO (1) new SP per environment, (2) auto populate SP ID here and in cf-objects service
              SERVICE_PRINCIPAL_SECRET:
                - '##secure_secret={"vault":"'
                - *kvName
                - '","secret_name":"'
                - *cfElmSecretName
                - '"}'
                - '##'
          container_settings:
            DOCKER_CUSTOM_IMAGE_NAME:
              - 'DOCKER|'
              - *primaryACR
              - '.azurecr.io/'
              - *elmWebApiContainer
              - ':'
              - *elmWebApiTag
            DOCKER_REGISTRY_SERVER_PASSWORD:
              - '##acr_registry_key={"registry":"'
              - *primaryACR
              - '","resource_group":"'
              - *cfAcrRG
              - '"}'
              - '##'
            DOCKER_REGISTRY_SERVER_USERNAME: *primaryACR
            DOCKER_REGISTRY_SERVER_URL: *uriPrimaryACR
            WEBSITES_ENABLE_APP_SERVICE_STORAGE: false
          logging: *defaultWebAppLogging
          tls: 'true'
          access_restrictions:
            - priority: 1
              rule_name: 'downstream AuthN'
              action: 'Allow'
              description: 'only allow access from downstream AuthN'
              ignore_missing_endpoint: 'true'
              scm_site: 'false'
              subnet:
                - '/subscriptions/'
                - *defaultAzureSubscription
                - '/resourceGroups/'
                - *cfAuthNSvcRG
                - '/providers/Microsoft.Network/virtualNetworks/'
                - *postAuthnGateway
                - 'Vnet'
                - '/subnets/default'
          action: 'create'
        # Self Healing services
        - name: &cfSelfHealingApp 'cf-prod-self-healing-app'
          arm_type: 'Microsoft.Web/sites'
          resource_group: *cfAppSvcRG
          container:
            registry: *primaryACR
            name: &shAPPContainer 'cf-self-healing-app-docker'
            tag: &shAPPTag 'connected-facilities'
          acr_webhook:
            name: 'cfprodselfhealingappwh'
            registry: *primaryACR
            resource_group: *cfAcrRG
            status: 'enabled'
            actions:
              - 'push'
            arm_type: 'Microsoft.ContainerRegistry/registries/webhooks'
          config:
            DOCKER_ENABLE_CI: true
            DOCKER_REGISTRY_SERVER_PASSWORD:
              - '##acr_registry_key={"registry":"'
              - *primaryACR
              - '","resource_group":"'
              - *cfAcrRG
              - '"}'
              - '##'
            DOCKER_REGISTRY_SERVER_URL: *uriPrimaryACR
            DOCKER_REGISTRY_SERVER_USERNAME: *primaryACR
            WEBSITES_ENABLE_APP_SERVICE_STORAGE: false
            WEBSITE_HTTPLOGGING_RETENTION_DAYS: 7
          connection_strings:
          container_settings:
            DOCKER_CUSTOM_IMAGE_NAME:
              - 'DOCKER|'
              - *primaryACR
              - '.azurecr.io/'
              - *shAPPContainer
              - ':'
              - *shAPPTag
            DOCKER_REGISTRY_SERVER_PASSWORD:
              - '##acr_registry_key={"registry":"'
              - *primaryACR
              - '","resource_group":"'
              - *cfAcrRG
              - '"}'
              - '##'
            DOCKER_REGISTRY_SERVER_USERNAME: *primaryACR
            DOCKER_REGISTRY_SERVER_URL: *uriPrimaryACR
            WEBSITES_ENABLE_APP_SERVICE_STORAGE: false
          logging: *defaultWebAppLogging
          tls: 'true'
          access_restrictions:
            - priority: 1
              rule_name: 'downstream AuthN'
              action: 'Allow'
              description: 'only allow access from downstream AuthN'
              ignore_missing_endpoint: 'true'
              scm_site: 'false'
              subnet:
                - '/subscriptions/'
                - *defaultAzureSubscription
                - '/resourceGroups/'
                - *cfAuthNSvcRG
                - '/providers/Microsoft.Network/virtualNetworks/'
                - *postAuthnGateway
                - 'Vnet'
                - '/subnets/default'
          action: 'create'
        - name: &cfSelfHealingApi 'cf-prod-self-healing-api'
          arm_type: 'Microsoft.Web/sites'
          resource_group: *cfAppSvcRG
          container:
            registry: *primaryACR
            name: &shAPIContainer 'cf-self-healing-api-docker'
            tag: &shAPITag 'connected-facilities'
          acr_webhook:
            name: 'cfprodselfhealingapiwh'
            registry: *primaryACR
            resource_group: *cfAcrRG
            status: 'enabled'
            actions:
              - 'push'
            arm_type: 'Microsoft.ContainerRegistry/registries/webhooks'
          config:
            API_KEY:
              - '##secure_secret={"vault":"'
              - *kvName
              - '","secret_name":"'
              - *cfDefaultSelfHealingApiKeyName
              - '"}'
              - '##'
            DATABASE_CONN_STRING: ''  # will be overridden by the connection string
            DOCKER_ENABLE_CI: true
            DOCKER_REGISTRY_SERVER_PASSWORD:
              - '##acr_registry_key={"registry":"'
              - *primaryACR
              - '","resource_group":"'
              - *cfAcrRG
              - '"}'
              - '##'
            DOCKER_REGISTRY_SERVER_URL: *uriPrimaryACR
            DOCKER_REGISTRY_SERVER_USERNAME: *primaryACR
            JWT_ISSUERS: *trustedIdProviders
            WEBSITES_ENABLE_APP_SERVICE_STORAGE: false
            WEBSITE_HTTPLOGGING_RETENTION_DAYS: 7
          connection_strings:
            SQLServer:
              DATABASE_CONN_STRING:
                - 'DRIVER={FreeTDS}'
                - ';'
                - 'SERVER='
                - *cfDefaultDbServer
                - '.database.windows.net'
                - ';'
                - 'DATABASE='
                - *selfHealingSchema
                - ';UID='
                - *cfDefaultDBAdminName
                - ';PWD='
                - '##secure_secret={"vault":"'
                - *kvName
                - '","secret_name":"'
                - *cfDefaultDBSecretName
                - '"}'
                - '##'
                - ';PORT='
                - 1433
          container_settings:
            DOCKER_CUSTOM_IMAGE_NAME:
              - 'DOCKER|'
              - *primaryACR
              - '.azurecr.io/'
              - *shAPIContainer
              - ':'
              - *shAPITag
            DOCKER_REGISTRY_SERVER_PASSWORD:
              - '##acr_registry_key={"registry":"'
              - *primaryACR
              - '","resource_group":"'
              - *cfAcrRG
              - '"}'
              - '##'
            DOCKER_REGISTRY_SERVER_USERNAME: *primaryACR
            DOCKER_REGISTRY_SERVER_URL: *uriPrimaryACR
            WEBSITES_ENABLE_APP_SERVICE_STORAGE: false
          logging: *defaultWebAppLogging
          tls: 'true'
          access_restrictions:
            - priority: 1
              rule_name: 'downstream AuthN'
              action: 'Allow'
              description: 'only allow access from downstream AuthN'
              ignore_missing_endpoint: 'true'
              scm_site: 'false'
              subnet:
                - '/subscriptions/'
                - *defaultAzureSubscription
                - '/resourceGroups/'
                - *cfAuthNSvcRG
                - '/providers/Microsoft.Network/virtualNetworks/'
                - *postAuthnGateway
                - 'Vnet'
                - '/subnets/default'
          action: 'create'
        # Atrius Objects Web API
        - name: &cfAtriusObjectsApi 'cf-prod-atrius-objects-api'
          arm_type: 'Microsoft.Web/sites'
          resource_group: *cfAppSvcRG
          container:
            registry: *primaryACR
            name: &atriusObjectsAPIContainer 'cf-atrius-objects-api-docker'
            tag: &shAPITag 'connected-facilities'
          acr_webhook:
            name: 'cfprodatriusobjectsapiwh'
            registry: *primaryACR
            resource_group: *cfAcrRG
            status: 'enabled'
            actions:
              - 'push'
            arm_type: 'Microsoft.ContainerRegistry/registries/webhooks'
          config:
            AUTHORIZED_USERS: *authorizedUsers
            DOCKER_ENABLE_CI: true
            DOCKER_REGISTRY_SERVER_PASSWORD:
              - '##acr_registry_key={"registry":"'
              - *primaryACR
              - '","resource_group":"'
              - *cfAcrRG
              - '"}'
              - '##'
            DOCKER_REGISTRY_SERVER_URL: *uriPrimaryACR
            DOCKER_REGISTRY_SERVER_USERNAME: *primaryACR
            ELM_LIGHTS_GROUPS_API_URL:
              - 'https://'
              - *wafFqdn
              - '/cf-elm/api/v1/light-groups/published-light-groups'
            JWT_ISSUERS: *trustedIdProviders
            SERVICE_PRINCIPAL_CLIENT_ID: '453111ae-5c35-4369-9807-2aff96da2def'
            SERVICE_PRINCIPAL_TENANT_ID: *acuityDefaultTenant
            SERVICE_PRINCIPAL_RESOURCE: *passageApiApplicationID
            WEBSITES_ENABLE_APP_SERVICE_STORAGE: false
            WEBSITE_HTTPLOGGING_RETENTION_DAYS: 7
          connection_strings:
            Custom:
              CF_DISTECH_LIGHTSMAP_API_KEY:
                - '##secure_secret={"vault":"'
                - *kvName
                - '","secret_name":"'
                - *cfLightsMapApiKey
                - '"}'
                - '##'
              DATABASE_URLS:
                - 'sqlserver://'
                - *cfObjectsDBUser_001
                - ':'
                - '##secure_secret={"vault":"'
                - *kvName
                - '","secret_name":"'
                - *cfObjectsDBSecretName_001
                - '"}'
                - '##'
                - '@'
                - *cfObjectsDBName_001
                - '.database.windows.net:1433/allspice-mapmanager01db'
                - ','
                - 'sqlserver://'
                - *cfObjectsDBUser_002
                - ':'
                - '##secure_secret={"vault":"'
                - *kvName
                - '","secret_name":"'
                - *cfObjectsDBSecretName_002
                - '"}'
                - '##'
                - '@'
                - *cfObjectsDBName_002
                - '.database.windows.net:1433/allspice-mapmanager01db'
              SERVICE_PRINCIPAL_SECRET:
                - '##secure_secret={"vault":"'
                - *kvName
                - '","secret_name":"'
                - *cfElmWebApiSPClientSecret
                - '"}'
                - '##'
          container_settings:
            DOCKER_CUSTOM_IMAGE_NAME:
              - 'DOCKER|'
              - *primaryACR
              - '.azurecr.io/'
              - *atriusObjectsAPIContainer
              - ':'
              - *shAPITag
            DOCKER_REGISTRY_SERVER_PASSWORD:
              - '##acr_registry_key={"registry":"'
              - *primaryACR
              - '","resource_group":"'
              - *cfAcrRG
              - '"}'
              - '##'
            DOCKER_REGISTRY_SERVER_USERNAME: *primaryACR
            DOCKER_REGISTRY_SERVER_URL: *uriPrimaryACR
            WEBSITES_ENABLE_APP_SERVICE_STORAGE: false
          logging: *defaultWebAppLogging
          tls: 'true'
          access_restrictions:
            - priority: 1
              rule_name: 'downstream AuthN'
              action: 'Allow'
              description: 'only allow access from downstream AuthN'
              ignore_missing_endpoint: 'true'
              scm_site: 'false'
              subnet:
                - '/subscriptions/'
                - *defaultAzureSubscription
                - '/resourceGroups/'
                - *cfAuthNSvcRG
                - '/providers/Microsoft.Network/virtualNetworks/'
                - *postAuthnGateway
                - 'Vnet'
                - '/subnets/default'
          action: 'create'
        # Bytelight site portal
        - name: &bytelightSitePortal 'cf-prod-bytelight-site-portal-app'
          arm_type: 'Microsoft.Web/sites'
          resource_group: *cfAppSvcRG
          container:
            registry: ''
            name: 'library/nginx'
            tag: 'stable'
          config:
            DOCKER_ENABLE_CI: true
            DOCKER_REGISTRY_SERVER_PASSWORD: ''
            DOCKER_REGISTRY_SERVER_URL: 'https://index.docker.io'
            DOCKER_REGISTRY_SERVER_USERNAME: ''
            WEBSITES_ENABLE_APP_SERVICE_STORAGE: false
            WEBSITE_HTTPLOGGING_RETENTION_DAYS: 7
          connection_strings:
          container_settings:
            DOCKER_CUSTOM_IMAGE_NAME: 'DOCKER|library/nginx:stable'
            DOCKER_REGISTRY_SERVER_PASSWORD: ''
            DOCKER_REGISTRY_SERVER_USERNAME: ''
            DOCKER_REGISTRY_SERVER_URL: 'https://index.docker.io'
            WEBSITES_ENABLE_APP_SERVICE_STORAGE: false
          logging: *defaultWebAppLogging
          tls: 'true'
          access_restrictions:
            - priority: 1
              rule_name: 'downstream AuthN'
              action: 'Allow'
              description: 'only allow access from downstream AuthN'
              ignore_missing_endpoint: 'true'
              scm_site: 'false'
              subnet:
                - '/subscriptions/'
                - *defaultAzureSubscription
                - '/resourceGroups/'
                - *cfAuthNSvcRG
                - '/providers/Microsoft.Network/virtualNetworks/'
                - *postAuthnGateway
                - 'Vnet'
                - '/subnets/default'
          action: 'create'
        # Echo debug service
        - name: &cfEchoDebug 'cf-prod-echo-debug-app'
          arm_type: 'Microsoft.Web/sites'
          resource_group: *cfAppSvcRG
          container:
            registry: ''
            name: 'mendhak/http-https-echo'
            tag: ''
          config:
            DOCKER_ENABLE_CI: true
            DOCKER_REGISTRY_SERVER_PASSWORD: ''
            DOCKER_REGISTRY_SERVER_URL: 'https://index.docker.io'
            DOCKER_REGISTRY_SERVER_USERNAME: ''
            WEBSITES_ENABLE_APP_SERVICE_STORAGE: false
            WEBSITE_HTTPLOGGING_RETENTION_DAYS: 7
          connection_strings:
          container_settings:
            DOCKER_CUSTOM_IMAGE_NAME: 'DOCKER|mendhak/http-https-echo'
            DOCKER_REGISTRY_SERVER_PASSWORD: ''
            DOCKER_REGISTRY_SERVER_USERNAME: ''
            DOCKER_REGISTRY_SERVER_URL: 'https://index.docker.io'
            WEBSITES_ENABLE_APP_SERVICE_STORAGE: false
          logging: *defaultWebAppLogging
          tls: 'true'
          access_restrictions:
            - priority: 1
              rule_name: 'downstream AuthN'
              action: 'Allow'
              description: 'only allow access from downstream AuthN'
              ignore_missing_endpoint: 'true'
              scm_site: 'false'
              subnet:
                - '/subscriptions/'
                - *defaultAzureSubscription
                - '/resourceGroups/'
                - *cfAuthNSvcRG
                - '/providers/Microsoft.Network/virtualNetworks/'
                - *postAuthnGateway
                - 'Vnet'
                - '/subnets/default'
          action: 'create'
    application_gateways:
      - name: *wafAgName
        arm_type: 'Microsoft.Network/applicationGateways'
        subscription: *defaultAzureSubscription
        resource_group: *cfWafRG
        capacity: 2
        min_capacity: 2
        max_capacity: 10
        frontend_port: 443
        http_settings_cookie_based_affinity: 'Disabled'
        http_settings_port: 443
        http_settings_protocol: 'Https'
        http2: 'Enabled'
        routing_rule_type: 'Basic'
        sku: 'WAF_v2'
        servers: &wafServers
          - *cfAuthnService
        address_pools: *wafServers
        private_ip_addresses: []
        # lessons learned: if a named pip exists and provided, but in a different RG, the WAF template tries to create
        # the same name in its own RG, and fails because it uses an incompatible SKU to do it.
        # the workarounds are to (1) create the named pip in the WAF RG prior to creating the WAF, or (2) use
        # the full resource ID path of the pre-existing pip in the other RG
        public_ip_addresses:
          - *wafIP
        waf_policy:
          name: 'cf-waf-policy'
          location: *defaultAzureLocation
          waf_config:
            state: 'Enabled'
            file_upload_limit_in_mb: '100'
            mode: 'Prevention'
            max_request_body_size_in_kb: '128'
            request_body_check: false  # @@ TODO make this true ... implement 128kb limit for ingest TECH DEBT
            rule_set_group_name: 'cf-waf-rule-set'
            rule_set_type: 'OWASP'
            rule_set_version: '3.1'
            exclusions:
              - matchVariable: 'RequestCookieNames'
                selector: 'ConnectedFacilities_AUTHN'
                selectorMatchOperator: 'StartsWith'
              - matchVariable: 'RequestArgNames'
                selector: 'code'
                selectorMatchOperator: 'Equals'
        tls_policy:
          name: 'cf-strict-tls-policy'
          cipherSuites:
            - 'TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384'
            - 'TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384'
            - 'TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256'
            - 'TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256'
            - 'TLS_DHE_RSA_WITH_AES_128_GCM_SHA256'
          minProtocolVersion: 'TLSv1_2'
          policyType: Custom
        ssl_certs:
          - name: 'wildcarddevatrius-iotcom'
            vault_name: *kvName
            subscription: *subscription_tls
        probe:
          name: &wafProbe 'cf-strict-probe'
          arm_type: 'Microsoft.Network/applicationGateways/probes'
          interval: 30
          timeout: 30
          match:
            statusCodes:
              - '200-399'
          minServers: 0
          path: '/'
          pickHostNameFromBackendHttpSettings: true
          protocol: 'Https'
          unhealthyThreshold: 3
        http_settings:
          name: &cfWafHttpSetting 'cf-default-http-settings'
          arm_type: 'Microsoft.Network/applicationGateways/backendHttpSettingsCollection'
          affinityCookieName: 'ApplicationGatewayAffinity'
          authenticationCertificates: []
          connectionDraining: 0
          cookieBasedAffinity: 'Disabled'
          pickHostNameFromBackendAddress: true
          port: 443
          probe:
            name: *wafProbe
          probeEnabled: true
          protocol: 'Https'
          requestTimeout: 20
          trustedRootCertificates: []
        rewrite_rule_sets:
          - name: &wafRewriteRuleSet 'security_headers'
            arm_type: 'Microsoft.Network/applicationGateways/rewriteRuleSets'
            rewriteRules:
              - actionSet:
                  requestHeaderConfigurations: []
                  responseHeaderConfigurations:
                    - headerName: 'Strict-Transport-Security'
                      headerValue: 'max-age=31536000'
                conditions: []
                name: 'HSTS'
                ruleSequence: 100
              - actionSet:
                  requestHeaderConfigurations: []
                  responseHeaderConfigurations:
                    - headerName: 'Referrer-Policy'
                      headerValue: 'strict-origin-when-cross-origin'
                conditions: []
                name: 'ReferrerPolicy'
                ruleSequence: 101
              - actionSet:
                  requestHeaderConfigurations: []
                  responseHeaderConfigurations:
                    - headerName: 'X-Frame-Options'
                      headerValue: 'sameorigin'
                conditions: []
                name: 'XFrameOptions'
                ruleSequence: 102
              - actionSet:
                  requestHeaderConfigurations: []
                  responseHeaderConfigurations:
                    - headerName: 'Content-Security-Policy'
                      headerValue: "default-src 'self'; frame-ancestors 'self' login.microsoft.com;"
                conditions:
                  - ignoreCase: true
                    negate: true
                    pattern: '^.+$'
                    variable: 'http_resp_Content-Security-Policy'
                name: 'ContentSecurityPolicy'
                ruleSequence: 103
              - actionSet:
                  requestHeaderConfigurations: []
                  responseHeaderConfigurations:
                    - headerName: 'Feature-Policy'
                      headerValue: >-
                        accelerometer 'none';
                        ambient-light-sensor 'none';
                        autoplay 'none';
                        battery 'none';
                        camera 'none';
                        display-capture 'none';
                        document-domain 'none';
                        encrypted-media 'none';
                        execution-while-not-rendered 'none';
                        execution-while-out-of-viewport 'none';
                        fullscreen 'none';
                        geolocation 'none';
                        gyroscope 'none';
                        layout-animations 'none';
                        legacy-image-formats 'none';
                        magnetometer 'none';
                        microphone 'none';
                        midi 'none';
                        oversized-images 'none';
                        payment 'none';
                        picture-in-picture 'none';
                        speaker 'none';
                        sync-xhr 'none';
                        unoptimized-images 'none';
                        unsized-media 'none';
                        usb 'none';
                        vibrate 'none';
                        vr 'none';
                        wake-lock 'none';
                        webauthn 'none';
                        vr 'none';
                        xr-spatial-tracking 'none';
                        xr 'none';
                conditions: []
                name: 'FeaturePolicy'
                ruleSequence: 104
              - actionSet:
                  requestHeaderConfigurations: []
                  responseHeaderConfigurations:
                    - headerName: 'X-Content-Type-Options'
                      headerValue: 'nosniff'
                conditions: []
                name: 'X-Content-Type-Options'
                ruleSequence: 108
              - actionSet:
                  requestHeaderConfigurations: []
                  responseHeaderConfigurations:
                    - headerName: 'Server'
                      headerValue: ''
                conditions: []
                name: 'DeleteServerHeader'
                ruleSequence: 110
              - actionSet:
                  requestHeaderConfigurations: []
                  responseHeaderConfigurations:
                    - headerName: 'Access-Control-Allow-Origin'
                      headerValue: 'https://login.microsoftonline.com'
                conditions: []
                name: 'AccessControlAllowOrigin'
                ruleSequence: 120
        request_routing_rules:
          - name: 'rule1'
            arm_type: 'Microsoft.Network/applicationGateways/requestRoutingRules'
            properties:
              address_pool: *cfAuthnService
              ruleType: 'Basic'
              http_setting: *cfWafHttpSetting
              rewrite_rule_set: *wafRewriteRuleSet  # @@ TODO -- manual at the moment - no way to set this via AZ CLI
        subnet_service_endpoints:
          - name: 'upstream authn access'
            subnet_name: 'default'
            service_endpoint_names:
              - 'Microsoft.Web'
        action: 'preserve'
      - name: *postAuthnGateway
        arm_type: 'Microsoft.Network/applicationGateways'
        subscription: *defaultAzureSubscription
        resource_group: *cfAuthNSvcRG
        capacity: 2
        frontend_port: 443
        http_settings_cookie_based_affinity: 'Disabled'
        http_settings_port: 443
        http_settings_protocol: 'Https'
        http2: 'Enabled'
        sku: 'Standard_v2'
        servers: &serverNames
          - *cfHealthApp
          - *authzWebApi
          - *adminWebApi
          - *elmWebApi
          - *healthWebApi
          - *ingestWebApi
          - *cfSelfHealingApp
          - *cfSelfHealingApi
          - *cfAtriusObjectsApi
          - *cfEchoDebug
          - *bytelightSitePortal
        address_pools: *serverNames
        private_ip_addresses: []
        public_ip_addresses:
          - *postAuthnIP
        waf_policy:
        tls_policy:
          name: 'cf-strict-tls-policy'
          cipherSuites:
            - 'TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384'
            - 'TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384'
            - 'TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256'
            - 'TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256'
            - 'TLS_DHE_RSA_WITH_AES_128_GCM_SHA256'
          minProtocolVersion: 'TLSv1_2'
          policyType: Custom
        ssl_certs:
          - name: 'wildcarddevatrius-iotcom'
            vault_name: *kvName
            subscription: *subscription_tls
        probe:
          name: &authnGwAppProbe 'cf-authn-strict-probe'
          arm_type: 'Microsoft.Network/applicationGateways/probes'
          interval: 30
          timeout: 30
          match:
            statusCodes:
              - '200-399'
          minServers: 0
          path: '/'
          pickHostNameFromBackendHttpSettings: true
          protocol: 'Https'
          unhealthyThreshold: 3
        http_settings:
          name: &postAuthNHttpSettings 'cf-authn-default-http-settings'
          arm_type: 'Microsoft.Network/applicationGateways/backendHttpSettingsCollection'
          affinityCookieName: 'ApplicationGatewayAffinity'
          authenticationCertificates: []
          connectionDraining: 0
          cookieBasedAffinity: 'Disabled'
          pickHostNameFromBackendAddress: true
          port: 443
          probe:
            name: *authnGwAppProbe
          probeEnabled: true
          protocol: 'Https'
          requestTimeout: 20
          trustedRootCertificates: []
        url_path_maps:  # basic strategy is one address pool per server type, and one server type per address pool
          - name: &postAuthnUrlPathMap 'cf-prod-post-authn-path-map-001'
            arm_type: Microsoft.Network/applicationGateways/urlPathMaps
            defaultBackendAddressPool: *cfHealthApp
            defaultBackendHttpSettings: *postAuthNHttpSettings
            defaultRedirectConfiguration: null
            defaultRewriteRuleSet: null
            pathRules:
              - name: 'post-authn-cf-health-app-path-rule'
                arm_type: 'Microsoft.Network/applicationGateways/urlPathMaps/pathRules'
                backendAddressPool: *cfHealthApp
                backendHttpSettings: *postAuthNHttpSettings
                paths:
                  - '/cf-app'
                  - '/cf-app/*'
                redirectConfiguration: null
                rewriteRuleSet: null
              - name: 'post-authn-authz-web-api-path-rule'
                arm_type: 'Microsoft.Network/applicationGateways/urlPathMaps/pathRules'
                backendAddressPool: *authzWebApi
                backendHttpSettings: *postAuthNHttpSettings
                paths:
                  - '/cf-authz'
                  - '/cf-authz/*'
                redirectConfiguration: null
                rewriteRuleSet: null
              - name: 'post-authn-admin-web-api-path-rule'
                arm_type: 'Microsoft.Network/applicationGateways/urlPathMaps/pathRules'
                backendAddressPool: *adminWebApi
                backendHttpSettings: *postAuthNHttpSettings
                paths:
                  - '/cf-admin'
                  - '/cf-admin/*'
                redirectConfiguration: null
                rewriteRuleSet: null
              - name: 'post-authn-elm-web-api-path-rule'
                arm_type: 'Microsoft.Network/applicationGateways/urlPathMaps/pathRules'
                backendAddressPool: *elmWebApi
                backendHttpSettings: *postAuthNHttpSettings
                paths:
                  - '/cf-elm'
                  - '/cf-elm/*'
                redirectConfiguration: null
                rewriteRuleSet: null
              - name: 'post-authn-health-web-api-path-rule'
                arm_type: 'Microsoft.Network/applicationGateways/urlPathMaps/pathRules'
                backendAddressPool: *healthWebApi
                backendHttpSettings: *postAuthNHttpSettings
                paths:
                  - '/cf-health'
                  - '/cf-health/*'
                redirectConfiguration: null
                rewriteRuleSet: null
              - name: 'post-authn-ingest-web-api-path-rule'
                arm_type: 'Microsoft.Network/applicationGateways/urlPathMaps/pathRules'
                backendAddressPool: *ingestWebApi
                backendHttpSettings: *postAuthNHttpSettings
                paths:
                  - '/cf-ingest'
                  - '/cf-ingest/*'
                redirectConfiguration: null
                rewriteRuleSet: null
              - name: 'post-authn-cf-self-healing-app-path-rule'
                arm_type: 'Microsoft.Network/applicationGateways/urlPathMaps/pathRules'
                backendAddressPool: *cfSelfHealingApp
                backendHttpSettings: *postAuthNHttpSettings
                paths:
                  - '/cf-self-healing'
                  - '/cf-self-healing/*'
                redirectConfiguration: null
                rewriteRuleSet: null
              - name: 'post-authn-cf-self-healing-api-path-rule'
                arm_type: 'Microsoft.Network/applicationGateways/urlPathMaps/pathRules'
                backendAddressPool: *cfSelfHealingApi
                backendHttpSettings: *postAuthNHttpSettings
                paths:
                  - '/cf-self-healing-api'
                  - '/cf-self-healing-api/*'
                redirectConfiguration: null
                rewriteRuleSet: null
              - name: 'post-authn-cf-atrius-objects-path-rule'
                arm_type: 'Microsoft.Network/applicationGateways/urlPathMaps/pathRules'
                backendAddressPool: *cfAtriusObjectsApi
                backendHttpSettings: *postAuthNHttpSettings
                paths:
                  - '/cf-atrius-objects'
                  - '/cf-atrius-objects/*'
                  - '/cf-lights-map'
                  - '/cf-lights-map/*'
                redirectConfiguration: null
                rewriteRuleSet: null
              - name: 'post-authn-cf-echo-debug-app-path-rule'
                arm_type: 'Microsoft.Network/applicationGateways/urlPathMaps/pathRules'
                backendAddressPool: *cfEchoDebug
                backendHttpSettings: *postAuthNHttpSettings
                paths:
                  - '/cf-echo'
                  - '/cf-echo/*'
                redirectConfiguration: null
                rewriteRuleSet: null
              - name: 'post-authn-bytelight-site-portal-app-path-rule'
                arm_type: 'Microsoft.Network/applicationGateways/urlPathMaps/pathRules'
                backendAddressPool: *bytelightSitePortal
                backendHttpSettings: *postAuthNHttpSettings
                paths:
                  - '/bytelight-site-portal'
                  - '/bytelight-site-portal/*'
                redirectConfiguration: null
                rewriteRuleSet: null
        request_routing_rules:
          - name: 'rule1'
            arm_type: 'Microsoft.Network/applicationGateways/requestRoutingRules'
            properties:
              address_pool: *cfHealthApp
              ruleType: 'PathBasedRouting'
              urlPathMap: *postAuthnUrlPathMap
              http_setting: *postAuthNHttpSettings
        subnet_service_endpoints:
          - name: 'upstream webapp access'
            subnet_name: 'default'
            service_endpoint_names:
              - 'Microsoft.Web'
        action: 'preserve'
    application_registration:  # @@ TODO manual - insufficient permissions from AZ CLI
      tenant: *appRegistrationTenant
      application_id: *passageApiApplicationID
      variables:
        app_auth_callback_url: *appAuthCallbackURL
      client_secret:
        vault: *kvName
        secret_name: *oauthProxyClientSecretName
        description: 'cf-prod-auth'  # unfortunately limited to 15 characters by AZ CLI

---
target:
  metadata:
    product_portfolio_name: &productName 'connected-facilities'
    environment_name: &environmentName 'Ci'
    default_azure_location: &defaultAzureLocation 'eastus'
    default_azure_subscription: &defaultAzureSubscription '5649ad97-1fd3-460f-b569-9995bbb6c5c0'  # Acuity Brands, Inc. ConnectedFacilities-Dev
    tls_cert_subscription: &subscription_tls '5e49f516-d005-4ae8-a287-031c8573401c'  # Acuity Brands, Inc. Allspice-Dev
    dns_subscription: &subscription_dns '5e49f516-d005-4ae8-a287-031c8573401c'  # Acuity Brands, Inc. Allspice-Dev
    service_deployment:
      tenant: &acuityDefaultTenant 'caadbe96-024e-4f67-82ec-fb28ff53d16d'  # Acuity Brands, Inc.
      authn_tenant: &environmentTenant 'common'  # allow all AD tenants to authenticate
      passage_api_fqdn: &passageApiFqdn 'passage.atrius-dev.acuitynext.io.'
      passage_partner_environment: &passagePartnerEnv 'ASP_DEV_US'
    app_registration:
      tenant: &appRegistrationTenant 'db566806-bf04-4296-98cc-ba6d2d950788'  # Acuity Brands Technical Services, INC
      application_id: &appRegistrationID '3a6085d9-676a-473c-832f-b73b2b7f7561'  # Acuity Brands Atrius Dev UI
      passage_api_application_id: &passageApiApplicationID '24b765b5-8108-4374-8141-1a65c0fc42ab'  # Acuity Brands Atrius Passage API
      # application_id: &appRegistrationID 'ca8318ee-a3f8-45d4-b284-0ec0ce809789'  # @@ TODO - manual setup due to insufficient permissions in AZ CLI
    objectsDatabases:
      - db_name: &cfObjectsDBName_001 'pltdata01sqlsep2ftp3b7r'
        reader_name: &cfObjectsDBUser_001 'CF_Reader'
        secret_name: &cfObjectsDBSecretName_001 'ALLSPICEDEV-CFReader-SQLUserPassword'
    key_names:
      self_healing_api_key: &cfDefaultSelfHealingApiKeyName 'cf-self-healing-api-key'
  iaas:
    location: *defaultAzureLocation
    resource_groups:
      # for naming conventions, see: https://docs.acuitynext.net/wiki/azure-naming-conventions/
      # pre-existing Atrius resource groups with shared configuration state
      - name: &atriusDnsRG 'atriusops-allspicedev'
        action: 'read'
      # CF Ci resource groups
      - name: &cfWafRG 'Waf-CfCi'
        action: 'create'
      - name: &cfDbRG 'Data-CfCi'
        action: 'create'
      - name: &cfKeysRG 'Kv-CfCi'
        action: 'create'
      - name: &cfAcrRG 'Acr-CfCi'
        action: 'create'
      - name: &cfK8sRG 'K8S-CfCi'
        action: 'create'
    networking:
      public_ip:
        - name: &wafIP 'cf-ci-waf-pip'
          resource_group: *cfWafRG
          subscription: *defaultAzureSubscription
          arm_type: 'Microsoft.Network/publicIPAddresses'
          sku: 'Standard'
          allocation_method: 'Static'
          action: 'create'
      dns_a_records:
        - zone: &dnsZone 'dev.atrius-iot.com'
          host: &dnsHost 'cf-ci'
          fqdn: &wafFqdn 'cf-ci.dev.atrius-iot.com.'
          resource_group: *atriusDnsRG
          subscription: *subscription_dns
          a_record_ttl: 3600
          a_record_public_ip: *wafIP
          action: 'create'
  paas:
    location: *defaultAzureLocation
    keyvaults:
      # pre-existing Atrius key vault with shared configuration state such as TLS certificate
      - name: &atriusKVName 'atrius01kvbxkbdsepg6'
        action: 'read'
      # CF Ci Key Vault
      - name: &kvName 'cf-ci-master-kv'
        resource_group: *cfKeysRG
        arm_type: 'Microsoft.KeyVault/vaults'
        action: 'create'
    service_principals:
      # for K8S to call Azure APIs
      - name: &spK8S 'cf-ci-k8s-sp'
        key_vault:
          vault: *kvName
          resource_group: *cfKeysRG
          secret_name: *spK8S
        role: 'Contributor'
        scopes:
          - '/subscriptions/'
          - *defaultAzureSubscription
          - '/resourceGroups/'
          - *cfK8sRG
        action: 'create'
      # for private calls to Atrius Objects Service
      - name: &spAtriusObjects 'cf-ci-atrius-objects-sp'
        key_vault:
          vault: *kvName
          resource_group: *cfKeysRG
          secret_name: *spAtriusObjects
        role: 'Contributor'
        scopes:
          - '/subscriptions/'
          - *defaultAzureSubscription
          - '/resourceGroups/'
          - *cfK8sRG
        action: 'create'
      # for calls to Passage API from ELM
      - name: &spElmAtrius 'cf-ci-elm-atrius-sp'
        key_vault:
          vault: *kvName
          resource_group: *cfKeysRG
          secret_name: *spElmAtrius
        role: 'Contributor'
        scopes:
          - '/subscriptions/'
          - *defaultAzureSubscription
          - '/resourceGroups/'
          - *cfK8sRG
        action: 'create'
    databases:
      servers:
        - name: &cfDefaultDbServer 'cf-ci-sqls'
          arm_type: 'Microsoft.Sql/servers'
          subscription: *defaultAzureSubscription
          resource_group: *cfDbRG
          admin_name: &cfDefaultDBAdminName 'cf-ci-sqls-admin-user'
          admin_password_kv:
            vault: *kvName
            resource_group: *cfKeysRG
            secret_name: &cfDefaultDBSecretName 'admin-pw-for-cf-ci-sqls'
          default_firewall_rule:
            name: 'AllowAllWindowsAzureIps'
            arm_type: 'Microsoft.Sql/servers/firewallRules'
            start_ip_address: '0.0.0.0'
            end_ip_address: '0.0.0.0'
          action: 'preserve'
      db_template: &dbTemplate
        arm_type: 'Microsoft.Sql/servers/databases'
        resource_group: *cfDbRG
        server: *cfDefaultDbServer
        license_type: 'LicenseIncluded'
        max_size: '250GB'
        zone_redundant: false
        catalog_collation: 'SQL_Latin1_General_CP1_CI_AS'
        collation: 'SQL_Latin1_General_CP1_CI_AS'
        capacity: 14
        tier: 'GeneralPurpose'
        family: 'Gen5'
        service_objective: 'GP_S_Gen5'
        action: 'preserve'
      instances:
        - name: &selfHealingSchema 'cf-ci-self-healing'
          <<: *dbTemplate
        - name: &authzSchema 'cf-ci-authz-db'
          <<: *dbTemplate
        - name: &netWorkViewSchema 'cf-ci-network-view-db'
          <<: *dbTemplate
        - name: &elmSchema 'cf-ci-elm-db'
          <<: *dbTemplate
        - name: &adminSchema 'cf-ci-admin-db'
          <<: *dbTemplate
    container_registries:
      - name: &primaryACR 'cfdevregistry'
        arm_type: 'Microsoft.ContainerRegistry/registries'
        resource_group: *cfAcrRG
        uri: &uriPrimaryACR 'https://cfdevregistry.azurecr.io'
        sku: 'Premium'
        admin_enabled: true
        action: 'create'
    k8s:
      clusters:
        - name: 'cf-ci-k8s-001'
          resource_group: *cfK8sRG
          location: *defaultAzureLocation
          # aad_client_app_id:
          # aad_server_app_id:
          # aad_server_app_secret:
          aad_tenant_id: *environmentTenant
          admin_username: 'cf-admin-user'
          # api_server_authorized_ip_ranges: '0.0.0.0/32'
          attach_acr: *primaryACR
          client_secret: '8e303b1e-1715-4633-aefd-34b78c56bb83'
          enable_cluster_autoscaler: 'true'
          enable_managed_identity: 'false'
          enable_private_cluster: 'false'
          generate_ssh_keys: 'true'
          kubernetes_version: '1.16.7'
          load_balancer_sku: 'standard'
          max_count: 100
          max_pods: 30
          min_count: 3
          network_plugin: 'azure'
          network_policy: 'calico'
          node_count: 3
          node_osdisk_size: '60'
          node_vm_size: 'Standard_DS2_v2'
          nodepool_labels: &labels 'cf-env=ci cf-role=ci'
          nodepool_name: 'cfnodepool'
          nodepool_tags: *labels
          service_principal: '7f4dedee-c3a2-47ac-a005-4bf1958d8f32'
          ssh_key_value: '~/.ssh/id_cf_ci_k8s.pub'
          tags: *labels
          vm_set_type: 'VirtualMachineScaleSets'
          zones: '1 2 3'
          subscription: *defaultAzureSubscription
          action: 'create'
      helm:
        values:
          - key:
            value:
  saas:
#    application_registration:  # @@ TODO manual - insufficient permissions from AZ CLI
#      tenant: *appRegistrationTenant
#      application_id: *passageApiApplicationID
#      variables:
#        app_auth_callback_url: *appAuthCallbackURL
#      client_secret:
#        vault: *kvName
#        secret_name: *oauthProxyClientSecretName
#        description: 'cf-ci-auth'  # unfortunately limited to 15 characters by AZ CLI
